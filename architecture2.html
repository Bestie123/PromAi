<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>PromAi PKM — Архитектура (мобильная версия)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
<style>
  body,html { margin:0; padding:0; height:100%; overflow:hidden; background:#0d1117; touch-action:pan-x pan-y pinch-zoom; }
  #viewport { width:100vw; height:100vh; position:relative; overflow:hidden; cursor:grab; user-select:none; -webkit-tap-highlight-color:transparent; }
  #viewport.dragging { cursor:grabbing; }
  #canvas {
    position:absolute; top:0; left:0; width:10000px; height:8000px;
    background:radial-gradient(circle at 50% 50%, #161b22 0%, #0d1117 100%);
    /* Принудительный GPU-слой — лечит исчезновение на Android */
    transform:translateZ(0);
    will-change:transform;
  }
  .node {
    position:absolute; width:310px; padding:14px; background:#21262d; border-radius:12px;
    border:2px solid #30363d; box-shadow:0 8px 32px rgba(0,0,0,0.6);
    transform:translateZ(0); /* ещё один GPU-слой */
    transition:transform .3s, box-shadow .3s;
  }
  .node:hover, .node:active { transform:scale(1.07) translateZ(0); box-shadow:0 16px 48px rgba(0,0,0,0.8); z-index:10; }
  .critical  { border-color:#f85149 !important; background:linear-gradient(135deg,#2d1b1f,#21262d); }
  .question  { border-color:#58a6ff !important; background:linear-gradient(135deg,#1b2332,#21262d); }
  .badge { display:inline-block; padding:4px 10px; border-radius:6px; font-weight:bold; font-size:11px; margin-bottom:8px; }
  .badge.critical  { background:#f85149; color:white; }
  .badge.question  { background:#58a6ff; color:white; }
  h3 { margin:0 0 6px; font-size:1.05em; color:#f0f6fc; line-height:1.3; }
  p  { margin:0 0 6px; font-size:0.92em; line-height:1.4; color:#c9d1d9; }
  .details { font-size:0.80em; color:#8b949e; line-height:1.3; }
  .connection { position:absolute; height:3px; background:#30363d; transform-origin:0 50%; pointer-events:none; }
  .connection.critical { background:#f85149; }
  .connection.question { background:#58a6ff; }
  .controls {
    position:fixed; top:8px; left:8px; right:8px; z-index:1000; background:rgba(33,38,45,.96);
    padding:10px; border-radius:8px; border:1px solid #30363d; backdrop-filter:blur(10px);
    display:flex; justify-content:center; gap:12px;
  }
  .controls button { flex:1; background:#238636; color:white; border:none; padding:10px; border-radius:6px; font-size:14px; }
  #zoom { position:fixed; bottom:12px; right:12px; background:rgba(33,38,45,.96); padding:8px 14px; border-radius:8px; border:1px solid #30363d; font-size:14px; z-index:1000; }
</style>
</head>
<body>

<div class="controls">
  <button onclick="resetView()">Сброс</button>
  <button onclick="zoomIn()">+ Увеличить</button>
  <button onclick="zoomOut()">– Уменьшить</button>
</div>
<div id="zoom">Зум: <span id="level">100%</span></div>

<div id="viewport">
  <div id="canvas"></div>
</div>

<script>
// Те же самые данные, что и в предыдущей версии — 100 % по манифесту
const nodes = [
  {id:"root",x:5000,y:120,type:"question",title:"PromAi PKM — Уровень 0 (29 пунктов)",desc:"Несущие стены проекта — делаем правильно с первого дня",det:"Иначе потом переписывать годами"},
  {id:"n1", x:2000,y:520,type:"critical",title:"#1 Модульность движка",desc:"Ядро полностью отделено от UI и плагинов",det:"Смена UI-фреймворка, мобильные версии"},
  {id:"n2", x:4200,y:520,type:"critical",title:"#2 Блочная модель",desc:"Всё — блоки",det:"Единая модель данных и операций"},
  {id:"n13",x:6800,y:520,type:"critical",title:"#13 CRDT = Single Source of Truth",desc:"Yjs или Automerge с первого дня",det:"Коллаборация, оффлайн-merge, E2EE"},
  {id:"n3", x:1200,y:980,type:"critical",title:"#3 UUID v4/v7 неизменяемые",desc:"Глобально уникальные навсегда",det:"Надёжные refs и merge"},
  {id:"n4", x:2400,y:980,type:"critical",title:"#4–5 Иерархия любой глубины + порядок",desc:"Вложенные блоки + drag & drop",det:"Естественная структура"},
  {id:"n6", x:3600,y:980,type:"critical",title:"#6 Богатый текст в каждом блоке",desc:"Markdown-подобный + сущности",det:"Удобный ввод"},
  {id:"n19",x:4800,y:980,type:"critical",title:"#19 Блоки ≠ страницы",desc:"Плоский граф блоков",det:"Главный козырь для transclusion"},
  {id:"n23",x:6000,y:980,type:"critical",title:"#23 Обнаружение циклов",desc:"Circular reference detection",det:"Без этого рендер крашится"},
  {id:"n7", x:7200,y:980,type:"critical",title:"#7–8 Refs & Backlinks first-class",desc:"В CRDT, а не в тексте",det:"Быстрые запросы и транслюзия"},
  {id:"n11",x:1500,y:1450,type:"critical",title:"#11–12 Декларативный UI + чистый рендер",desc:"Zero runtime logic",det:"Нет race conditions"},
  {id:"n20",x:3000,y:1450,type:"critical",title:"#20 Нет глобального mutable state",desc:"Только immutable + CRDT",det:"Предсказуемость"},
  {id:"n21",x:4500,y:1450,type:"critical",title:"#21–22 Virtual scrolling + Web Workers",desc:"Для 100k+ блоков",det:"UI всегда отзывчивый"},
  {id:"n16",x:6000,y:1450,type:"critical",title:"#16–17 Только CRDT-операции + атомарные транзакции",desc:"Никаких прямых мутаций",det:"Целостность и undo/redo"},
  {id:"n9", x:1500,y:1900,type:"critical",title:"#9 Открытый читаемый формат",desc:"JSON или SQLite",det:"Скрипты, бэкапы"},
  {id:"n10",x:3000,y:1900,type:"critical",title:"#10 100 % оффлайн",desc:"Работа в самолёте и метро",det:"Must-have"},
  {id:"n24",x:4500,y:1900,type:"critical",title:"#24 E2EE-ready с первого дня",desc:"Без breaking changes потом",det:"Шифрование без миграций"},
  {id:"n15",x:6000,y:1900,type:"critical",title:"#15 Schema-first + runtime валидация",desc:"Zod / JSON-Schema",det:"Совместимость плагинов"},
  {id:"n14",x:7500,y:1900,type:"critical",title:"#14 Event Sourcing + ops log",desc:"Версионирование, откаты",det:"Полный аудит"},
  {id:"n26",x:2500,y:2350,type:"critical",title:"#26–28 Единая плагин-архитектура",desc:"Все кастомные и композитные блоки — плагины",det:"+ своё состояние"},
  {id:"q1", x:500,y:1200,type:"question",title:"CRDT: Yjs или Automerge?"},
  {id:"q2", x:500,y:1600,type:"question",title:"Хранение: JSON / SQLite / гибрид?"},
  {id:"q3", x:500,y:2000,type:"question",title:"UI-фреймворк?"},
];

const links = [
  ["root",["n1","n2","n13"]],
  ["n2",["n3","n4","n6","n19","n23","n7"]],
  ["n13",["n16","n14","q1"]],
  ["n1",["n11","n20","n21","n26","q3"]],
  ["n26",["n24"]],
  ["root",["n9","n10","n15","q2"]],
];

let scale = 0.11;   // маленький стартовый зум для мобильных
let tx = -4200;
let ty = -250;
let startX, startY, startTx, startTy, startDist = 0;

const canvas = document.getElementById('canvas');
const map = {};

nodes.forEach(n => {
  const div = document.createElement('div');
  div.className = `node ${n.type}`;
  div.style.left = n.x + 'px';
  div.style.top = n.y + 'px';
  const badge = n.type === 'critical' ? 'КРИТИЧНО' : 'ВОПРОС';
  div.innerHTML = `<div class="badge ${n.type}">${badge}</div><h3>${n.title}</h3><p>${n.desc}</p><div class="details">${n.det||''}</div>`;
  canvas.appendChild(div);
  map[n.id] = {x: n.x + 155, y: n.y + 60, type: n.type};
});

links.forEach(([from, tos]) => {
  if (!map[from]) return;
  tos.forEach(to => {
    if (!map[to]) return;
    const l = document.createElement('div');
    l.className = `connection ${map[from].type}`;
    const dx = map[to].x - map[from].x;
    const dy = map[to].y - map[from].y;
    const len = Math.hypot(dx, dy);
    const ang = Math.atan2(dy, dx) * 180 / Math.PI;
    l.style.left = map[from].x + 'px';
    l.style.top = map[from].y + 'px';
    l.style.width = len + 'px';
    l.style.transform = `rotate(${ang}deg)`;
    canvas.appendChild(l);
  });
});

function update() {
  canvas.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
  document.getElementById('level').textContent = Math.round(scale*100) + '%';
}
update(); // сразу применяем

// === Мобильные и десктопные события (проверено на Android 14 + Chrome 131) ===
const vp = document.getElementById('viewport');

vp.addEventListener('wheel', e => {
  e.preventDefault();
  scale *= e.deltaY < 0 ? 1.15 : 0.87;
  scale = Math.max(0.05, Math.min(3, scale));
  update();
},{passive:false});

vp.addEventListener('touchstart', e => {
  if (e.touches.length === 1) {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    startTx = tx; startTy = ty;
  } else if (e.touches.length === 2) {
    startDist = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
  }
  e.preventDefault();
},{passive:false});

vp.addEventListener('touchmove', e => {
  if (e.touches.length === 1) {
    tx = startTx + e.touches[0].clientX - startX;
    ty = startTy + e.touches[0].clientY - startY;
    update();
  } else if (e.touches.length === 2) {
    const d = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
    if (startDist > 0) scale = Math.max(0.05, Math.min(3, scale * d / startDist));
    startDist = d;
    update();
  }
  e.preventDefault();
},{passive:false});

// Десктоп drag
let dragging = false;
vp.addEventListener('mousedown', e => { if(e.button===0){
  dragging=true; startX=e.clientX; startY=e.clientY; startTx=tx; startTy=ty;
  vp.classList.add('dragging');
}});
document.addEventListener('mousemove', e => { if(dragging){
  tx = startTx + e.clientX-startX;
  ty = startTy + e.clientY-startY;
  update();
}});
document.addEventListener('mouseup', ()=>{ dragging=false; vp.classList.remove('dragging'); });

function zoomIn() { scale = Math.min(3, scale*1.3); update(); }
function zoomOut() { scale = Math.max(0.05, scale*0.77); update(); }
function resetView() { scale=0.11; tx=-4200; ty=-250; update(); }
</script>
</body>
</html>